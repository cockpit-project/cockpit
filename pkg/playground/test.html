<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Cockpit terminal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../@@latest@@/cockpit.css" type="text/css" rel="stylesheet">
    <script src="../@@latest@@/cockpit.js"></script>
</head>
<body style="display: none;">
    <div id="internal" class="container-fluid">
        <img src="hammer.gif" style="float: right;" onclick="$(this).hide();">
        <div id="nav"></div>
        <button class="btn btn-default" id="go-down">Go down</button>
        <br/>
        <br/>
        <div class="cockpit-internal-reauthorize">
            <button class="btn btn-default">Priveleged Action</button>
            <span></span>
        </div>
        <div class="super-channel">
            <button class="btn btn-default">Superuser</button>
            <span></span>
        </div>
        <p>Translated text: <span translatable="yes">Networking</span></p>
        <p>On the fly: <span id="translation"></span> <span id="reverse"></span></p>
    </div>
<script>
require([
    'jquery',
    'latest/cockpit',
    'playground/po'
], function($, cockpit, po) {
    var loc = cockpit.locale(po);
    var _ = loc.gettext;
    var C_ = loc.gettext;

    $("#translation").text(_("Translation"));
    $("#reverse").text(C_("reverse", "Translation"));

    $(".cockpit-internal-reauthorize .btn").on("click", function() {
         $(".cockpit-internal-reauthorize span").text("checking...");
         var cmd = "pkcheck --action-id org.freedesktop.policykit.exec --process $$ -u 2>&1";
         cockpit.spawn(["sh", "-c", cmd]).
             stream(function(data) {
                 console.debug(data);
             }).
             done(function() {
                 $(".cockpit-internal-reauthorize span").text("result: authorized");
             }).
             fail(function() {
                 $(".cockpit-internal-reauthorize span").text("result: not-authorized");
             });
         });

    $(".super-channel .btn").on("click", function() {
         $(".super-channel span").text("checking...");
         cockpit.spawn(["id"], { "superuser": true }).
             done(function(data) {
                 console.log("done");
                 $(".super-channel span").text("result: " + data);
             }).
             fail(function(ex) {
                 console.log("fail");
                 $(".super-channel span").text("result: " + ex.problem);
             });
         });

    function update_nav() {
        $('#nav').empty();
        var path = [ "top" ].concat(cockpit.location.path);
        $(path).each(function (i, p) {
            if (i < path.length-1) {
                $('#nav').append(
                    $('<a>').
                        text(p).
                        click(function () {
                            cockpit.location.go(path.slice(1,i+1));
                        }),
                    " >> ");
            } else {
                $('#nav').append(
                    $('<span>').text(p));
            }
        });
    }

    $(cockpit).on('locationchanged', update_nav);
    update_nav();

    $('#go-down').click(function () {
        var len = cockpit.location.path.length;
        cockpit.location.go(cockpit.location.path.concat(len.toString()), { length: len.toString() });
    });

    $("body").show();
});
</script>
</body>
</html>

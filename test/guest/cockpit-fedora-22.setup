#! /bin/bash

set -ex

# HACK - virt-resize might not be able to resize our xfs rootfs,
# depending on how it was compiled and which plugins are installed,
# and will just silently not do it.  So we do it here.
#
xfs_growfs /
df -h /

echo foobar | passwd --stdin root

# We install all dependencies of the cockpit packages since we want
# them to not spontaneously change from one test run to the next when
# the distribution repository is updated.
#
COCKPIT_DEPS="\
json-glib \
realmd \
glib-networking \
libssh \
selinux-policy-targeted \
docker \
pcp-libs \
pcp \
kubernetes \
etcd \
subscription-manager \
storaged \
storaged-lvm2 \
device-mapper-multipath \
atomic \
"

# We also install the packages necessary to join a FreeIPA domain so
# that we don't have to go to the network during a test run.
#
IPA_CLIENT_PACKAGES="\
freeipa-client \
oddjob \
oddjob-mkhomedir \
sssd \
"

TEST_PACKAGES="\
systemtap-runtime-virtguest \
valgrind \
gdb \
"

rm -rf /etc/sysconfig/iptables

maybe() { if type "$1" >/dev/null 2>&1; then "$@"; fi; }

# For the D-Bus test server
maybe firewall-cmd --permanent --add-port 8765/tcp

echo 'NETWORKING=yes' > /etc/sysconfig/network

useradd -u 1000 -c Administrator -G wheel admin
echo foobar | passwd --stdin admin

# Let's upgrade dnf first and then use the new dnf to upgrade
# the rest. This helps avoid things like:
#
#     https://bugzilla.redhat.com/show_bug.cgi?id=1211547
#
dnf -y upgrade dnf
dnf -y upgrade

# We need storaged 2 from the phatine/storaged copr.  We wait until
# here to enable it in order to use a up-to-date version of the dnf
# "copr" plugin: https://bugzilla.redhat.com/show_bug.cgi?id=1273738
#
dnf -y copr enable phatina/storaged

dnf -y install $TEST_PACKAGES $COCKPIT_DEPS $IPA_CLIENT_PACKAGES

# Prepare for building
dnf -y install mock
useradd -u 2000 -c Builder -G mock builder
su - builder -c "mock --installdeps $TEST_SOURCE_PACKAGE"

dnf clean all

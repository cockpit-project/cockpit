#! /bin/bash
# This file is part of Cockpit.
#
# Copyright (C) 2013 Red Hat, Inc.
#
# Cockpit is free software; you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation; either version 2.1 of the License, or
# (at your option) any later version.
#
# Cockpit is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with Cockpit; If not, see <http://www.gnu.org/licenses/>.

set -euf

usage()
{
	echo "usage: minify [-n] file ..." >&2
	exit 2
}

fake=no

while getopts "n" opt; do
	case "$opt" in
	n)
		fake=yes
		;;
	*)
		usage
		;;
	esac
done

shift $(expr $OPTIND - 1)

fake_minify()
{
	echo "/* This file is automatically generated; DO NOT EDIT */"
	cat "$@"
}

if [ $fake = "yes" ]; then
	fake_minify "$@"
	exit 0
fi

perl -e \
'use strict;
use JavaScript::Minifier::XS qw(minify);

for my $f (@ARGV) {
    local ($/);
    open my $in, "<", $f or die "$f: $!\n";
    print minify(<$in>);
    close $in;
}' $@ \
|| (
	echo >&2 "minify: no worries, using cat instead"
	fake_minify "$@"
   )

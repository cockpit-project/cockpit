#! /bin/bash

# We install all dependencies of the cockpit packages since we want
# them to not spontaneously change from one test run to the next when
# the distribution repository is updated.
#
COCKPIT_DEPS="accountsservice-libs udisks2 libudisks2 json-glib realmd sshpass lvm2 mdadm glib-networking libssh storaged"

# We also install the packages necessary to join a FreeIPA domain so
# that we don't have to go to the network during a test run.
#
IPA_CLIENT_PACKAGES="freeipa-client oddjob oddjob-mkhomedir sssd"

echo 'SELINUX=disabled' > /etc/selinux/config

rm -rf /etc/sysconfig/iptables

COCKPIT_DEPS_BASEURL=${COCKPIT_DEPS_BASEURL:=http://cockpit-project.github.io/cockpit-deps}
COCKPIT_DEPS_URL=${COCKPIT_DEPS_BASEURL}/$TEST_OS/$TEST_ARCH

echo "[cockpit-deps]
name=Unreleased Cockpit dependencies
baseurl=${COCKPIT_DEPS_URL}
enabled=1
gpgcheck=0" > /etc/yum.repos.d/cockpit-deps.repo

maybe() { if type "$1" >/dev/null 2>&1; then "$@"; fi; }

# For Cockpit
maybe firewall-cmd --permanent --add-port 21064/tcp

# For the D-Bus test server
maybe firewall-cmd --permanent --add-port 8765/tcp

echo 'NETWORKING=yes' > /etc/sysconfig/network

useradd -u 1000 -c Administrator -G wheel admin
echo foobar | passwd --stdin admin

# To enable persistent logging
mkdir -p /var/log/journal

yes | yum update -y
yes | yum install -y $COCKPIT_DEPS $IPA_CLIENT_PACKAGES

# Stopping a user@.service at poweroff sometimes hangs and then times
# out, but that seems to be harmless otherwise.  We reduce the timeout
# so that we don't have to wait for the default 90 seconds.
#
f=/usr/lib/systemd/system/user@.service
if [ -f $f ] && ! grep -q TimeoutStopSec $f; then
  echo TimeoutStopSec=1 >>$f
  systemctl daemon-reload
fi

# We rely on the NetworkManager dispatcher, but it sometimes is
# disabled after the update above.  So let's make sure it is enabled.
#
systemctl enable NetworkManager-dispatcher

# https://bugzilla.redhat.com/show_bug.cgi?id=1057236
sed -i -e 's/-u ntp:ntp //' /usr/lib/systemd/system/ntpd.service

rm -rf /var/log/journal/*

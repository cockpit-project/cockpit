#!/usr/bin/env python
# -*- coding: utf-8 -*-

# This file is part of Cockpit.
#
# Copyright (C) 2015 Red Hat, Inc.
#
# Cockpit is free software; you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation; either version 2.1 of the License, or
# (at your option) any later version.
#
# Cockpit is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with Cockpit; If not, see <http://www.gnu.org/licenses/>.

import argparse
import json
import os
import subprocess
import sys

parser = argparse.ArgumentParser(description='Get a virtual machine image')
parser.add_argument('-v', '--verbose', action='store_true', help='Display verbose details')
parser.add_argument('-f', '--flavor', action='store', default='cockpit', help='The flavor to download')
parser.add_argument('-F', '--force', action='store_true', help='Always create image from scratch')
args = parser.parse_args()

topdir = os.path.normpath(os.path.dirname(__file__))
arch = os.getenv("TEST_ARCH", "x86_64")
system = os.getenv("TEST_OS", "fedora-22")
images = os.path.join(os.getenv("TEST_DATA", topdir), "images")

with open(os.path.join(topdir, "guest", args.flavor + ".conf")) as fp:
    config = json.load(fp)
    revision = config.get('tags', { }).get(system, '0')
    key = args.flavor + "-" + system + "-" + revision
    image = os.path.join(images, args.flavor + "-" + system + "-" + arch + "-" + revision)

if not args.force and os.path.exists(image):
    if args.verbose:
        sys.stderr.write("vm-download: image already present: " + image + "\n")
    sys.exit(0)

if not os.path.exists(images):
    os.makedirs(images)

cmd = [
    "virt-builder",
    "--no-cache",
    "--no-check-signature", # Unfortunately, not ready for this yet
    "--arch", arch,
    "--format=qcow2",
    "--output", image,
    "--root-password=password:foobar",
    "--source", "http://files.cockpit-project.org/testdata/images/index",
    key
]

if args.verbose:
    cmd += [ "--verbose" ]

os.execvp(cmd[0], cmd)

#!/usr/bin/python
# -*- coding: utf-8 -*-

# This file is part of Cockpit.
#
# Copyright (C) 2015 Red Hat, Inc.
#
# Cockpit is free software; you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation; either version 2.1 of the License, or
# (at your option) any later version.
#
# Cockpit is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with Cockpit; If not, see <http://www.gnu.org/licenses/>.

import os
import sys

import testvm
from testlib import *

avocado_tests = ["checkexample-foo.py",
                 "checklogin-basic.py",  "checklogin-raw.py", ]


class TestAvocadoSuite(MachineCase):

    def setUp(self):
        MachineCase.setUp(self)
        self.machine_test_dir = "/tmp/avocado_tests"
        self.m = self.machine
        self.workaround()
        self.start_cockpit()

    def workaround(self):
        self.m.execute("yum -y install npm fontconfig")
        self.m.execute("npm -g install phantomjs")

    def testAvocado(self):
        self.m.execute(command="mkdir -p " + MachineCase.avocado_results_dir)
        # first upload all of the tests to the target machine
        self.m.upload([os.path.join(self.m.test_dir, "avocado")],
                      self.machine_test_dir)
        # upload sizzle.js to proper dir
        self.m.upload([os.path.join(self.m.test_dir, "sizzle.js")],
                      self.machine_test_dir)

        cmd_parts = ["avocado run",
                     "--job-results-dir " + MachineCase.avocado_results_dir,
                     ' '.join([self.machine_test_dir +
                               os.sep + x for x in avocado_tests])
                     ]

        try:
            self.m.execute(" ".join(cmd_parts))
        except:
            self.fail("avocado tests failed")

if __name__ == '__main__':
    test_main()

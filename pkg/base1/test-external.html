<!DOCTYPE html>
<!--
  This file is part of Cockpit.

  Copyright (C) 2014 Red Hat, Inc.

  Cockpit is free software; you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation; either version 2.1 of the License, or
  (at your option) any later version.

  Cockpit is distributed in the hope that it will be useful, but
  WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with Cockpit; If not, see <http://www.gnu.org/licenses/>.
-->
<html>
  <head>
    <title>External Channel Tests</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../tools/qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="../../tools/qunit.js"></script>

    <script type="text/javascript" src="cockpit.js"></script>
  </head>
  <body>
    <h1 id="qunit-header">External Channel Tests</h1>
    <h2 id="qunit-banner"></h2><div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2><ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <div id="done-flag" style="display:none">Done</div>
  </body>
<script type="text/javascript">

asyncTest("external get", function() {
    expect(7);

    var channel = cockpit.channel({ "payload": "fslist1", "path": "/tmp", "watch": false, "external": { } });
    var req = null;

    $(channel).on("control", function(ev, options) {
        equal(options.command, "ready", "got ready");
        strictEqual(req, null, "one ready message");

        target = options.target;
        equal(typeof (target), "string", "got target")

        req = new XMLHttpRequest();
        req.open("GET", "/cockpit/" + target);
        req.onreadystatechange = function() {
            if (req.readyState == 4) {
                equal(this.status, 200, "got right status");
                equal(this.statusText, "OK", "got right reason");
                equal(this.getResponseHeader("Content-Type"), "text/plain", "default type");
                ok(this.responseText.indexOf('"present"'), "got listing");
                channel.close();
                $(channel).off();
                start();
            }
        };
        req.send();
    });

    $(channel).on("message", function(ev, payload) {
        notOk(true, "shouldn't get payload here");
    });
});

asyncTest("external headers", function() {
    expect(6);

    var channel = cockpit.channel({ "payload": "fslist1", "path": "/tmp", "watch": false,
                                    "external": { "disposition": "my disposition; blah", "type": "test/blah" } });
    var req = null;

    $(channel).on("control", function(ev, options) {
        equal(options.command, "ready", "got ready");
        strictEqual(req, null, "one ready message");

        target = options.target;
        equal(typeof (target), "string", "got target")

        req = new XMLHttpRequest();
        req.open("GET", "/cockpit/" + target);
        req.onreadystatechange = function() {
            if (req.readyState == 4) {
                equal(this.status, 200, "got right status");
                equal(this.getResponseHeader("Content-Type"), "test/blah", "got type");
                equal(this.getResponseHeader("Content-Disposition"), "my disposition; blah", "got disposition");
                channel.close();
                $(channel).off();
                start();
            }
        };
        req.send();
    });

    $(channel).on("message", function(ev, payload) {
        ok(false, "shouldn't get payload here");
    });
});

asyncTest("external invalid", function() {
    expect(1);

    var req = new XMLHttpRequest();
    req.open("GET", "/cockpit/channel/invalid");
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
            equal(this.status, 404, "got not found");
            start();
        }
    }
    req.send();
});

asyncTest("external websocket", function() {
    expect(6);

    var channel = cockpit.channel({ "payload": "echo", "external": { } });
    var count = 0;
    var ws = null;

    $(channel).on("control", function(ev, options) {
        equal(options.command, "ready", "got ready");
        strictEqual(ws, null, "one ready message");

        target = options.target;
        equal(typeof (target), "string", "got target")

        ws = new WebSocket("ws://" + location.host + "/cockpit/" + target, "protocol-unused");
        ws.onopen = function() {
            ok(true, "websocket is open");
            ws.send("oh marmalade");
        };
        ws.onerror = function() {
            ok(false, "websocket error");
        };
        ws.onmessage = function(ev) {
            if (count == 0) {
                equal(ev.data, "oh marmalade", "got payload");
                ws.send("another test");
                count += 1;
            } else {
                equal(ev.data, "another test", "got payload again");
                ws.close(1000);
            }
        };
        ws.onclose = function() {
            channel.close();
            $(channel).off();
            start();
        }
    });

    $(channel).on("message", function(ev, payload) {
        notOk(true, "shouldn't get payload here");
    });
});


QUnit.start();

</script>
</html>

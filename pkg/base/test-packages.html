<!DOCTYPE html>
<!--
  This file is part of Cockpit.

  Copyright (C) 2014 Red Hat, Inc.

  Cockpit is free software; you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation; either version 2.1 of the License, or
  (at your option) any later version.

  Cockpit is distributed in the hope that it will be useful, but
  WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with Cockpit; If not, see <http://www.gnu.org/licenses/>.
-->
<html>
<head>
    <title>Package Tests</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../lib/qunit-1.14.0.css" type="text/css" media="screen" />
    <script src="../../lib/jquery.v2.1.0.js"></script>
    <script src="../../lib/qunit-1.14.0.js"></script>
    <script src="../../lib/qunit-tap.js"></script>
    <script src="../../tools/qunit-config.js"></script>

    <script src="cockpit.js"></script>
</head>
<body>
    <h1 id="qunit-header">Spawn Tests</h1>
    <h2 id="qunit-banner"></h2><div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2><ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <div id="done-flag" style="display:none">Done</div>
</body>
<script>

window.debugging = "package";

test("public api", function() {
    equal(typeof cockpit.packages, "object", "cockpit.packages is a function");
    equal(typeof cockpit.packages.lookup, "function", "cockpit.packages.lookup is a function");
});

asyncTest("lookup", function() {
    expect(6);

    cockpit.packages.lookup("test").
        done(function(pkg) {
            equal(pkg.name, "test", "package name");
            equal(pkg.checksum, "$fec489a692ee808950f34f6c519803aed65e1849", "package checksum");
            equal(typeof pkg.manifest, "object", "package manifest");
            equal(pkg.manifest.description, "dummy", "package manifest contents");
            deepEqual(pkg.manifest.alias, [ ], "package alias");
        }).
        always(function() {
            equal(this.state(), "resolved", "succeeded");
            start();
        });
});

asyncTest("not found", function() {
    expect(2);

    cockpit.packages.lookup("invalid").
        fail(function(ex) {
            equal(ex.problem, "not-found", "right problem");
        }).
        always(function() {
            equal(this.state(), "rejected", "failed");
            start();
        });
});

asyncTest("aliases", function() {
    expect(3);

    cockpit.packages.lookup("one").
        done(function(pkg) {
            equal(pkg.name, "second", "package name");
            deepEqual(pkg.manifest.alias, [ "one", "two", ], "listed");
        }).
        always(function() {
            equal(this.state(), "resolved", "succeeded");
            start();
        });
});


QUnit.start();

</script>
</html>

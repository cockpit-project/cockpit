#!/bin/sh -ex

# semaphore has a hacked phantomjs-prebuilt cached which points to /usr/local/bin/phantomjs
[ -x node_modules/phantomjs-prebuilt/lib/phantom/bin/phantomjs ] || rm -rf node_modules/phantomjs-prebuilt

# temporary shim, remove once landed on master and semaphore config got updated
if [ "$1" = i386 ]; then
    sudo docker run --volume `pwd`:/source:ro cockpit/unit-tests:i386
elif [ "${CC#clang}" != "$CC" ]; then
    sudo docker run --env=CC=clang --volume `pwd`:/source:ro cockpit/unit-tests
else
    # standard arch/compiler
    sudo docker run --volume `pwd`:/source:ro cockpit/unit-tests
fi

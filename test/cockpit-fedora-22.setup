#! /bin/bash

set -x

echo foobar | passwd --stdin root

# We install all dependencies of the cockpit packages since we want
# them to not spontaneously change from one test run to the next when
# the distribution repository is updated.
#

COCKPIT_DEPS="udisks2 json-glib realmd lvm2 mdadm glib-networking libssh selinux-policy-targeted docker pcp-libs pcp kubernetes etcd subscription-manager"

# We also install the packages necessary to join a FreeIPA domain so
# that we don't have to go to the network during a test run.
#
IPA_CLIENT_PACKAGES="freeipa-client oddjob oddjob-mkhomedir sssd"

TEST_PACKAGES="systemtap-runtime-virtguest"

rm -rf /etc/sysconfig/iptables

maybe() { if type "$1" >/dev/null 2>&1; then "$@"; fi; }

# For the D-Bus test server
maybe firewall-cmd --permanent --add-port 8765/tcp

echo 'NETWORKING=yes' > /etc/sysconfig/network

useradd -u 1000 -c Administrator -G wheel admin
echo foobar | passwd --stdin admin

# Let's not use dynamic mirrors since we might pretty much randomly
# get different sets of packages.
#
# Once Fedora 22 is released, this needs to be reviewed and adapted.
#
sed -i -e 's/#baseurl/baseurl/' -e 's/metalink/#metalink/' -e 's,http://download,http://dl,' -e 's/releases/development/' -e 's,Everything/,,' /etc/yum.repos.d/*.repo

# Let's enable updates-testing.
#
dnf config-manager --set-enabled updates-testing

# Let's upgrade dnf first and then use the new dnf to upgrade
# the rest. This helps avoid things like:
#
#     https://bugzilla.redhat.com/show_bug.cgi?id=1211547
#
dnf -y upgrade dnf

dnf -y upgrade
dnf -y install $TEST_PACKAGES $COCKPIT_DEPS $IPA_CLIENT_PACKAGES

rm -rf /var/log/journal/*

ln -sf ../selinux/config /etc/sysconfig/selinux
echo 'SELINUX=enforcing' > /etc/selinux/config

touch /.autorelabel

# Audit events to the journal
rm -f '/etc/systemd/system/multi-user.target.wants/auditd.service'
rm -rf /var/log/audit/

# docker image that we need for integration testing
systemctl start docker
docker pull busybox

<!DOCTYPE html>
<html>
    <head>
        <title>Cockpit starting...</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="//code.jquery.com/jquery-1.11.3.min.js" type="text/javascript"></script>
        <script>

var tap_range = /^([0-9]+)\.\.([0-9]+)$/m;
var tap_result = /^(ok|not ok) ([0-9]+) (.*$)/gm;
var tap_skipped = /^ok [0-9]+ ([^#].*) # SKIP (.*$)/gm;

function extract(text) {
    var m;
    var first, last, total, passed, failed, skipped;

    $('#testing').hide();

    if (m = tap_range.exec(text)) {
        first = parseInt(m[1]);
        last = parseInt(m[2]);
        total = last-first+1;

        passed = 0;
        failed = 0;
        $('#failures').empty();
        while (m = tap_result.exec(text)) {
            if(m[1] == "ok")
                passed += 1;
            else {
                failed += 1;
                $('#failures').append($('<li>').text(m[3]));
            }
        }
        skipped = 0;
        while (m = tap_skipped.exec(text)) {
            skipped += 1;
            passed -= 1;
            $('#skipped-tests').append($('<li>').text(m[1] + " -- " + m[2]));
        }

        $('#total').text(total);
        $('#passed').text(passed);
        $('#failed').text(failed);
        $('#skipped').text(skipped);
        $('#left').text(total - passed - failed - skipped);
        $('#testing').show();
    }
}

var interval_id;

function poll() {
    $.get("log", "text").
        done(function (text) {
            $('#log').text(text);
            extract(text);
        });

    $.get("status", "json").
        done(function (text) {
            var status = JSON.parse(text);
            $('#message').text(status.message);
            $('#status').show();
            clearInterval(interval_id);
        });
}

$(function () {
    interval_id = setInterval(poll, 30000);
    poll();
});

  </script>
</head>
  <body>
    <h1>Logs</h1>
    <p>
      <a href=".">Result directory</a>
    </p>
    <p id="testing" style="display:none">
      <span id="total"></span> tests,
      <span id="passed"></span> passed,
      <span id="failed"></span> failed,
      <span id="skipped"></span> skipped,
      <span id="left"></span> to go.<br>
      <span>Failed tests:</span>
          <ul id="failures"></ul>
      <span>Skipped tests:</span>
          <ul id="skipped-tests"></ul>
    </p>
    <p id="status" style="display:none">
      Done: <span id="message"></span>.
    </p>
    <pre id="log">
    </pre>
  </body>
</html>

#!/usr/bin/env python
# -*- coding: utf-8 -*-

# This file is part of Cockpit.
#
# Copyright (C) 2017 Red Hat, Inc.
#
# Cockpit is free software; you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation; either version 2.1 of the License, or
# (at your option) any later version.
#
# Cockpit is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with Cockpit; If not, see <http://www.gnu.org/licenses/>.

# To use this example add a line to an issue with the "bot" label
#
#  * [ ] naughty-prune
#

import os
import sys
import subprocess
import time

sys.dont_write_bytecode = True

import task

# Number of days after which a known issue is treated as stale
DAYS = 14

BOTS = os.path.abspath(os.path.dirname(__file__))
BASE = os.path.normpath(os.path.join(BOTS, ".."))

def execute(*args):
    if task.verbose:
        sys.stderr.write("+ " + " ".join(args) + "\n")
    return subprocess.check_output(args, cwd=BASE)

def run(unused, verbose=False, **kwargs):

    # Since a month ago
    since = time.time() - (DAYS * 86400)

    # The head
    head = execute("git", "rev-parse", "HEAD").strip()

    # Don't replace this issue with the pull request(s)
    if "issue" in kwargs:
        del kwargs["issue"]

    # Get all the open known issues
    issues = task.api.issues(labels=["knownissue"])
    for issue in issues:
        number = issue["number"]

        updated = issue.get("updated_at", None)
        if not updated:
            updated = issue.get("created_at", None)

        # Don't touch recently updated issues
        if updated and since > time.mktime(time.strptime(updated, "%Y-%m-%dT%H:%M:%SZ")):
            continue

        # Try to close this issue
        execute("git", "checkout", "--detach", head)
        execute("find", "bots/images/", "-name", "{0}-*".format(number), "-delete")

        # Create a pull request from these changes
        title = "naughty: Close {0}".format(issue["title"])
        body = "Close and remove known issue\n\n{0}\n\nCloses #{1}".format(issue["title"], number)
        branch = task.branch(number, title, pathspec="bots/images/", **kwargs)

        if branch:
            task.pull(branch, body=body, **kwargs)

if __name__ == '__main__':
    task.main(function=run, title="Close known issues")

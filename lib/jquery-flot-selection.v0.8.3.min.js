(function(e){function t(t){var n={first:{x:-1,y:-1},second:{x:-1,y:-1},show:false,active:false};var o={};var i=null;function s(e){if(n.active){d(e);t.getPlaceholder().trigger("plotselecting",[l()])}}function r(t){if(t.which!=1)return;document.body.focus();if(document.onselectstart!==undefined&&o.onselectstart==null){o.onselectstart=document.onselectstart;document.onselectstart=function(){return false}}if(document.ondrag!==undefined&&o.ondrag==null){o.ondrag=document.ondrag;document.ondrag=function(){return false}}u(n.first,t);n.active=true;i=function(e){c(e)};e(document).one("mouseup",i)}function c(e){i=null;if(document.onselectstart!==undefined)document.onselectstart=o.onselectstart;if(document.ondrag!==undefined)document.ondrag=o.ondrag;n.active=false;d(e);if(x())a();else{t.getPlaceholder().trigger("plotunselected",[]);t.getPlaceholder().trigger("plotselecting",[null])}return false}function l(){if(!x())return null;if(!n.show)return null;var o={},i=n.first,s=n.second;e.each(t.getAxes(),function(e,t){if(t.used){var n=t.c2p(i[t.direction]),r=t.c2p(s[t.direction]);o[e]={from:Math.min(n,r),to:Math.max(n,r)}}});return o}function a(){var e=l();t.getPlaceholder().trigger("plotselected",[e]);if(e.xaxis&&e.yaxis)t.getPlaceholder().trigger("selected",[{x1:e.xaxis.from,y1:e.yaxis.from,x2:e.xaxis.to,y2:e.yaxis.to}])}function f(e,t,n){return t<e?e:t>n?n:t}function u(e,o){var i=t.getOptions();var s=t.getPlaceholder().offset();var r=t.getPlotOffset();e.x=f(0,o.pageX-s.left-r.left,t.width());e.y=f(0,o.pageY-s.top-r.top,t.height());if(i.selection.mode=="y")e.x=e==n.first?0:t.width();if(i.selection.mode=="x")e.y=e==n.first?0:t.height()}function d(e){if(e.pageX==null)return;u(n.second,e);if(x()){n.show=true;t.triggerRedrawOverlay()}else g(true)}function g(e){if(n.show){n.show=false;t.triggerRedrawOverlay();if(!e)t.getPlaceholder().trigger("plotunselected",[])}}function h(e,n){var o,i,s,r,c=t.getAxes();for(var l in c){o=c[l];if(o.direction==n){r=n+o.n+"axis";if(!e[r]&&o.n==1)r=n+"axis";if(e[r]){i=e[r].from;s=e[r].to;break}}}if(!e[r]){o=n=="x"?t.getXAxes()[0]:t.getYAxes()[0];i=e[n+"1"];s=e[n+"2"]}if(i!=null&&s!=null&&i>s){var a=i;i=s;s=a}return{from:i,to:s,axis:o}}function m(e,o){var i,s,r=t.getOptions();if(r.selection.mode=="y"){n.first.x=0;n.second.x=t.width()}else{s=h(e,"x");n.first.x=s.axis.p2c(s.from);n.second.x=s.axis.p2c(s.to)}if(r.selection.mode=="x"){n.first.y=0;n.second.y=t.height()}else{s=h(e,"y");n.first.y=s.axis.p2c(s.from);n.second.y=s.axis.p2c(s.to)}n.show=true;t.triggerRedrawOverlay();if(!o&&x())a()}function x(){var e=t.getOptions().selection.minSize;return Math.abs(n.second.x-n.first.x)>=e&&Math.abs(n.second.y-n.first.y)>=e}t.clearSelection=g;t.setSelection=m;t.getSelection=l;t.hooks.bindEvents.push(function(e,t){var n=e.getOptions();if(n.selection.mode!=null){t.mousemove(s);t.mousedown(r)}});t.hooks.drawOverlay.push(function(t,o){if(n.show&&x()){var i=t.getPlotOffset();var s=t.getOptions();o.save();o.translate(i.left,i.top);var r=e.color.parse(s.selection.color);o.strokeStyle=r.scale("a",.8).toString();o.lineWidth=1;o.lineJoin=s.selection.shape;o.fillStyle=r.scale("a",.4).toString();var c=Math.min(n.first.x,n.second.x)+.5,l=Math.min(n.first.y,n.second.y)+.5,a=Math.abs(n.second.x-n.first.x)-1,f=Math.abs(n.second.y-n.first.y)-1;o.fillRect(c,l,a,f);o.strokeRect(c,l,a,f);o.restore()}});t.hooks.shutdown.push(function(t,n){n.unbind("mousemove",s);n.unbind("mousedown",r);if(i)e(document).unbind("mouseup",i)})}e.plot.plugins.push({init:t,options:{selection:{mode:null,color:"#e8cfac",shape:"round",minSize:5}},name:"selection",version:"1.1"})})(jQuery);
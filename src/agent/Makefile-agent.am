
noinst_LIBRARIES += libcockpit-agent.a

libcockpit_agent_a_SOURCES = \
	src/agent/cockpitchannel.c \
	src/agent/cockpitchannel.h \
	src/agent/cockpitdbusjson.c \
	src/agent/cockpitdbusjson.h \
	src/agent/cockpitdbusjson1.c \
	src/agent/cockpitdbusjson1.h \
	src/agent/cockpitfakemanager.c \
	src/agent/cockpitfakemanager.h \
	src/agent/cockpitpackage.c \
	src/agent/cockpitpackage.h \
	src/agent/cockpitpolkitagent.c \
	src/agent/cockpitpolkitagent.h \
	src/agent/cockpitnullchannel.c \
	src/agent/cockpitnullchannel.h \
	src/agent/cockpitresource.c \
	src/agent/cockpitresource.h \
	src/agent/cockpitrestjson.c \
	src/agent/cockpitrestjson.h \
	src/agent/cockpittextstream.c \
	src/agent/cockpittextstream.h \
	$(NULL)

libcockpit_agent_a_CFLAGS = \
	$(cockpit_cppflags_common) \
	$(cockpit_cppflags_glib_version) \
	-DG_LOG_DOMAIN=\"cockpit-agent\" \
	$(COCKPIT_AGENT_CFLAGS) \
	$(WARN_CFLAGS) \
	$(NULL)

libcockpit_agent_LIBS = \
	libcockpit-agent.a \
	libcockpit-common.a \
	libwebsocket.a \
	$(COCKPIT_AGENT_LIBS) \
	$(NULL)

# -----------------------------------------------------------------------------

libexec_PROGRAMS += cockpit-agent cockpit-polkit

cockpit_agent_SOURCES = src/agent/agent.c
cockpit_agent_CFLAGS = \
	-DG_LOG_DOMAIN=\"cockpit-agent\" \
	$(COCKPIT_AGENT_CFLAGS) \
	$(NULL)
cockpit_agent_LDADD = $(libcockpit_agent_LIBS)

cockpit_polkit_SOURCES = src/agent/cockpitpolkithelper.c
cockpit_polkit_CFLAGS = $(COCKPIT_POLKIT_CFLAGS)
cockpit_polkit_LDADD = libreauthorize.a $(REAUTHORIZE_LIBS) $(COCKPIT_POLKIT_LIBS)

# polkit-agent-helper-1 need to be setuid root because polkit wants
# responses to come from a root process
install-data-hook::
	-chown root:0 $(DESTDIR)$(libexecdir)/cockpit-polkit
	-chown root:0 $(DESTDIR)$(libexecdir)/cockpit-polkit
	-chmod 4755 $(DESTDIR)$(libexecdir)/cockpit-polkit

EXTRA_DIST += \
	src/agent/cockpit.pam.insecure \
	src/agent/sshd-reauthorize.pam \
	$(NULL)

# -----------------------------------------------------------------------------
# TESTS

AGENT_CHECKS = \
	test-channel \
	test-fakemanager \
	test-dbusjson \
	test-restjson \
	test-textstream \
	test-package \
	test-resource \
	$(NULL)

test_channel_SOURCES = \
	src/agent/test-channel.c \
	src/agent/mock-transport.c src/agent/mock-transport.h
test_channel_CFLAGS = $(libcockpit_agent_a_CFLAGS)
test_channel_LDADD = $(libcockpit_agent_LIBS)

test_dbusjson_SOURCES = src/agent/test-dbusjson.c $(mock_dbus_sources)
nodist_test_dbusjson_SOURCES = $(test_built_sources)
test_dbusjson_CFLAGS = $(libcockpit_agent_a_CFLAGS)
test_dbusjson_LDADD = $(libcockpit_agent_LIBS)

test_package_SOURCES = src/agent/test-package.c
test_package_CFLAGS = $(libcockpit_agent_a_CFLAGS)
test_package_LDADD = $(libcockpit_agent_LIBS)

test_restjson_SOURCES = src/agent/test-restjson.c
test_restjson_CFLAGS = $(libcockpit_agent_a_CFLAGS)
test_restjson_LDADD = $(libcockpit_agent_LIBS)

test_textstream_SOURCES = \
	src/agent/test-textstream.c \
	src/agent/mock-transport.c src/agent/mock-transport.h
test_textstream_CFLAGS = $(libcockpit_agent_a_CFLAGS)
test_textstream_LDADD = $(libcockpit_agent_LIBS)

test_resource_SOURCES = \
	src/agent/test-resource.c \
	src/agent/mock-transport.c src/agent/mock-transport.h
test_resource_CFLAGS = $(libcockpit_agent_a_CFLAGS)
test_resource_LDADD = $(libcockpit_agent_LIBS)

nodist_test_fakemanager_SOURCES = $(test_dbus_generated)
test_fakemanager_SOURCES = \
	src/agent/test-fakemanager.c \
	$(mock_dbus_sources)
test_fakemanager_CFLAGS = $(libcockpit_agent_a_CFLAGS)
test_fakemanager_LDADD = $(libcockpit_agent_LIBS)

noinst_PROGRAMS += $(AGENT_CHECKS)
TESTS += $(AGENT_CHECKS)

EXTRA_DIST += \
	src/agent/mock-resource

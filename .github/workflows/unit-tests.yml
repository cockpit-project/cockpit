name: unit-tests
on: [pull_request, workflow_dispatch]
jobs:
  unit-tests:
    runs-on: ubuntu-22.04
    permissions: {}
    container: quay.io/cockpit/tasks:latest
    strategy:
      matrix:
        scenario:
          - { make: 'check-memory', cc: 'gcc' }
          - { make: 'distcheck', cc: 'clang' }
          # this runs static code checks, unlike distcheck
          - { make: 'check', cc: 'gcc' }
          - { make: 'pytest-cov', cc: 'gcc' }
      fail-fast: false
    timeout-minutes: 60
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          # need this to also fetch tags
          fetch-depth: 0

      - name: Run unit test
        timeout-minutes: 30
        # HACK: -gdwarf-4 is for clang: https://bugs.kde.org/show_bug.cgi?id=452758
        run: |
            env FORCE_COLOR=1 \
            CC='${{ matrix.scenario.cc }}' \
            CFLAGS='-O2 -gdwarf-4' \
            make '${{ matrix.scenario.make }}'

<!DOCTYPE html>
<!--
This file is part of Cockpit.

Copyright (C) 2014 Red Hat, Inc.

Cockpit is free software; you can redistribute it and/or modify it
under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation; either version 2.1 of the License, or
(at your option) any later version.

Cockpit is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with Cockpit; If not, see <http://www.gnu.org/licenses/>.
-->
<html>
<head>
    <meta charset="utf-8">
    <title>D-Bus Tests</title>
    <link rel="stylesheet" href="../../lib/qunit-1.14.0.css" type="text/css" media="screen" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="../../lib/qunit-1.14.0.js"></script>
    <script type="text/javascript" src="../../lib/qunit-tap.js"></script>
    <script type="text/javascript" src="../../tools/qunit-config.js"></script>

    <script type="text/javascript" src="cockpit.js"></script>
</head>
<body>
    <h1 id="qunit-header">D-Bus Tests</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <div id="done-flag" style="display:none">Done</div>
<script>

asyncTest("call method", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    equal(typeof dbus.call, "function", "call method: is a function");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
              "HelloWorld", [ "Browser-side JS" ]).
        done(function(reply) {
            deepEqual(reply, [ "Word! You said `Browser-side JS'. I'm Skeleton, btw!" ],
                      "call method: reply");
        }).
        always(function() {
            equal(this.state(), "resolved", "call method: finished successfuly");
            start();
        });
});

asyncTest("primitive types", function() {
    expect(2);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
              "TestPrimitiveTypes", [
                    10, true, 11, 12, 13, 14, 15, 16, 17,
                    "a string", "/a/path", "asig",
                    "ZWZnAA==" ]).
        done(function(reply) {
            deepEqual(reply, [
                20, false, 111, 1012, 10013, 100014, 1000015, 10000016, 17.0 / Math.PI,
                "Word! You said `a string'. Rock'n'roll!", "/modified/a/path", "assgitasig",
                "Ynl0ZXN0cmluZyH/AA=="
            ], "primitive types: round trip");
        }).
        always(function() {
            equal(this.state(), "resolved", "primitive types: finished successfuly");
            start();
        });
});

asyncTest("non-primitive types", function() {
    expect(2);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
              "TestNonPrimitiveTypes", [
                    {one: "red", two: "blue"},
                    {first: [42, 42], second: [43, 43]},
                    [42, 'foo', 'bar'],
                    ["one", "two"],
                    ["/one", "/one/two"],
                    ["ass", "git"],
                    ["QUIA", "QkMA"] ]).
        done(function(reply) {
            deepEqual(reply, [
                    "{'one': 'red', 'two': 'blue'}{'first': (42, 42), 'second': (43, 43)}(42, 'foo', 'bar')array_of_strings: [one, two] array_of_objpaths: [/one, /one/two] array_of_signatures: [signature 'ass', 'git'] array_of_bytestrings: [AB, BC] "
            ] , "non-primitive types: round trip");
        }).
        always(function() {
            equal(this.state(), "resolved", "non-primitive types: finished successfuly");
            start();
        });
});

asyncTest("variants", function() {
    expect(2);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
                "TestAsv", [ {
                   one: cockpit.variant("s", "foo"),
                   two: cockpit.variant("o", "/bar"),
                   three: cockpit.variant("g", "assgit"),
                   four: cockpit.variant("y", 42),
                   five: cockpit.variant("d", 1000.0)
                } ]).
        done(function(reply) {
            deepEqual(reply, [
                    "{'one': <'foo'>, 'two': <objectpath '/bar'>, 'three': <signature 'assgit'>, 'four': <byte 0x2a>, 'five': <1000.0>}"
            ] , "variants: round trip");
        }).
        always(function() {
            equal(this.state(), "resolved", "variants: finished successfuly");
            start();
        });
});

asyncTest("bad variants", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
                "TestAsv", [ {
                    one: "foo",
                    two: "/bar",
                    three: "assgit",
                    four: 42,
                    five: 1000.0
                } ]).
        fail(function(ex) {
            equal(ex.name, "org.freedesktop.DBus.Error.InvalidArgs", "bad variants: error name");
            equal(ex.message, "Unexpected type 'string' in argument", "bad variants: error message");
        }).
        always(function() {
            equal(this.state(), "rejected", "bad variants: should fail");
            start();
        });
});

asyncTest("bad variants", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
                "TestAsv", [ {
                    one: "foo",
                    two: "/bar",
                    three: "assgit",
                    four: 42,
                    five: 1000.0
                } ]).
        fail(function(ex) {
            equal(ex.name, "org.freedesktop.DBus.Error.InvalidArgs", "bad variants: error name");
            equal(ex.message, "Unexpected type 'string' in argument", "bad variants: error message");
        }).
        always(function() {
            equal(this.state(), "rejected", "bad variants: should fail");
            start();
        });
});

asyncTest("get all", function() {
   expect(2);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "org.freedesktop.DBus.Properties",
              "GetAll", [ "com.redhat.Cockpit.DBusTests.Frobber" ]).
        done(function(reply) {
            deepEqual(reply, [ {
                "FinallyNormalName": { "t": "s", "v": "There aint no place like home" },
                "ReadonlyProperty": { "t": "s", "v": "blah" },
                "aay": { "t": "aay", "v": [] },
                "ag": { "t": "ag", "v": [] },
                "ao": { "t": "ao", "v": [] },
                "as": { "t": "as", "v": [] },
                "ay": { "t": "ay", "v": "QUJDYWJjAA==" },
                "b": { "t": "b", "v": false },
                "d": { "t": "d", "v": 43 },
                "g": { "t": "g", "v": "" },
                "i": { "t": "i", "v": 0 },
                "n": { "t": "n", "v": 0 },
                "o": { "t": "o", "v": "/" },
                "q": { "t": "q", "v": 0 },
                "s": { "t": "s", "v": "" },
                "t": { "t": "t", "v": 0 },
                "u": { "t": "u", "v": 0 },
                "x": { "t": "x", "v": 0 },
                "y": { "t": "y", "v": 42 }
           } ], "get all: reply");
        }).
        always(function() {
            equal(this.state(), "resolved", "call method: finished successfuly");
            start();
        });
});

asyncTest("call unimplemented", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
              "UnimplementedMethod", [ ]).
        fail(function(ex) {
            equal(ex.name, "org.freedesktop.DBus.Error.UnknownMethod", "call unimplemented: error name");
            equal(ex.message, "Method UnimplementedMethod is not implemented on interface com.redhat.Cockpit.DBusTests.Frobber", "call unimplemented: error message");
        }).
        always(function() {
            equal(this.state(), "rejected", "call unimplemented: should fail");
            start();
        });
});

asyncTest("call bad base64", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
              "TestPrimitiveTypes", [ 10, true, 11, 12, 13, 14, 15, 16, 17, "a string", "/a/path", "asig",
                    "Yooohooo!~ bad base64" ]).
        fail(function(ex) {
            equal(ex.name, "org.freedesktop.DBus.Error.InvalidArgs", "call bad base64: error name");
            equal(ex.message, "Invalid base64 in argument", "call bad base64: error message");
        }).
        always(function() {
            equal(this.state(), "rejected", "call bad base64: should fail");
            start();
        });
});

asyncTest("call unknown", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
            "UnknownBlahMethod", [ 1 ]).
        fail(function(ex) {
            equal(ex.name, "org.freedesktop.DBus.Error.UnknownMethod", "unknown method: error name");
            equal(ex.message, "Introspection data for method com.redhat.Cockpit.DBusTests.Frobber on D-Bus interface UnknownBlahMethod not available", "unknown method: error message");
        }).
        always(function() {
            equal(this.state(), "rejected", "unknown method: should fail");
            start();
        });
});

asyncTest("signals", function() {
    expect(6);

    var received = false;
    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    var id = dbus.subscribe({
        "interface": "com.redhat.Cockpit.DBusTests.Frobber",
        "path": "/otree/frobber"
        }, function(path, iface, signal, args) {
            if (received)
                return;
            equal(path, "/otree/frobber", "signals: got right path");
            equal(iface, "com.redhat.Cockpit.DBusTests.Frobber", "signals: got right path");
            equal(signal, "TestSignal", "signals: got right path");
            deepEqual(args, [
                    43, [ "foo", "frobber" ], [ "/foo", "/foo/bar" ],
                    { "first": [ 42, 42 ], "second": [ 43, 43 ] } ], "signals: got right arguments");
            received = true;
        });

    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber", "RequestSignalEmission", [ 0 ]).
        always(function() {
            equal(this.state(), "resolved", "signals: emmision requested");
            equal(received, true, "signals: signal received");
            start();
        });
});

asyncTest("signal unsubscribe", function() {
    expect(4);

    var received = true;
    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");

    function on_signal() {
        received = true;
    }

    var subscription = dbus.subscribe({
        "interface": "com.redhat.Cockpit.DBusTests.Frobber",
        "path": "/otree/frobber"
        }, on_signal);

    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber", "RequestSignalEmission", [ 0 ]).
        always(function() {
            equal(this.state(), "resolved", "signals: emmision requested");
            equal(received, true, "signals: signal received");
        }).then(function() {
            subscription.remove();
            received = false;

            dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber", "RequestSignalEmission", [ 0 ]).
                always(function() {
                    equal(this.state(), "resolved", "signals: second emmision requested");
                    equal(received, false, "signals: signal not received");
                    start();
                });
        });
});

asyncTest("with types", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/bork", "borkety.Bork", "Echo",
              [ {one: "red", two: "blue"}, 55, 66, 32 ],
              { type: "a{ss}uit" }).
        done(function(reply, options) {
            deepEqual(reply, [ {one: "red", two: "blue"}, 55, 66, 32 ], "with types: round trip");
            equal(options.type, "a{ss}uit", "with types: got back type");
        }).
        always(function() {
            equal(this.state(), "resolved", "with types: finished successfuly");
            start();
        });
});

asyncTest("bad types", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/bork", "borkety.Bork", "Echo", [ 1 ],
              { type: "!!%%" }).
        fail(function(ex) {
            equal(ex.name, "org.freedesktop.DBus.Error.InvalidArgs", "bad types: error name");
            equal(ex.message, "Type signature is not valid: !!%%", "bad types: error message");
        }).
        always(function() {
            equal(this.state(), "rejected", "bad types: should fail");
            start();
        });
});

asyncTest("bad dict type", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
              "Nobody", [ { "!!!": "value" } ], { type: "a{is}" }).
        fail(function(ex) {
            equal(ex.name, "org.freedesktop.DBus.Error.InvalidArgs", "bad dict type: error name");
            equal(ex.message, "Unexpected key '!!!' in dict entry", "bad dict type: error message");
        }).
        always(function() {
            equal(this.state(), "rejected", "bad dict type: should fail");
            start();
        });
});

asyncTest("bad object path", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
              "Nobody", [ "not/a/path" ], { type: "o" }).
        fail(function(ex) {
            equal(ex.name, "org.freedesktop.DBus.Error.InvalidArgs", "bad object path: error name");
            equal(ex.message, "Invalid object path 'not/a/path'", "bad object path: error message");
        }).
        always(function() {
            equal(this.state(), "rejected", "bad object path: should fail");
            start();
        });
});

asyncTest("bad signature", function() {
    expect(3);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test");
    dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
              "Nobody", [ "bad signature" ], { type: "g" }).
        fail(function(ex) {
            equal(ex.name, "org.freedesktop.DBus.Error.InvalidArgs", "bad signature: error name");
            equal(ex.message, "Invalid signature 'bad signature'", "bad signature: error message");
        }).
        always(function() {
            equal(this.state(), "rejected", "bad signature: should fail");
            start();
        });
});

QUnit.start();
</script>
</body>
</html>

<!DOCTYPE html>
<!--
  This file is part of Cockpit.

  Copyright (C) 2014 Red Hat, Inc.

  Cockpit is free software; you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation; either version 2.1 of the License, or
  (at your option) any later version.

  Cockpit is distributed in the hope that it will be useful, but
  WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with Cockpit; If not, see <http://www.gnu.org/licenses/>.
-->
<html>
  <head>
    <title>Spawn Tests: Real Process</title>
    <link rel="stylesheet" href="../../lib/qunit-1.14.0.css" type="text/css" media="screen" />
    <script type="text/javascript" src="../../lib/jquery.v2.1.0.js"></script>
    <script type="text/javascript" src="../../lib/qunit-1.14.0.js"></script>
    <script type="text/javascript" src="../../lib/qunit-tap.js"></script>
    <script type="text/javascript" src="../../tools/qunit-config.js"></script>

    <script type="text/javascript" src="cockpit.js"></script>
  </head>
  <body>
    <h1 id="qunit-header">Spawn Tests</h1>
    <h2 id="qunit-banner"></h2><div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2><ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <div id="done-flag" style="display:none">Done</div>
  </body>
<script type="text/javascript">

asyncTest("simple process", function() {
    expect(2);
    cockpit.spawn(["/bin/sh", "-c", "echo hi"]).
        done(function(resp) {
            equal(resp, "hi\n", "returned output");
        }).
        always(function() {
            equal(this.state(), "resolved", "didn't fail");
            start();
        });
});

asyncTest("path", function() {
    expect(1);
    cockpit.spawn(["true"]).
        always(function() {
            equal(this.state(), "resolved", "found executable");
            start();
        });
});

asyncTest("directory", function() {
    expect(2);
    cockpit.spawn(["pwd"], { directory: "/tmp" }).
        done(function(resp) {
            equal(resp, "/tmp\n", "was right");
        }).
        always(function() {
            equal(this.state(), "resolved", "didn't fail");
            start();
        });
});

asyncTest("error log", function() {
    expect(2);
    cockpit.spawn(["/bin/sh", "-c", "echo hi; echo yo >&2"]).
        done(function(resp) {
            equal(resp, "hi\n", "produced no output");
        }).
        always(function() {
            equal(this.state(), "resolved", "didn't fail");
            start();
        });
});

asyncTest("error output", function() {
    expect(2);
    cockpit.spawn(["/bin/sh", "-c", "echo hi; echo yo >&2"], { error: "output" }).
        done(function(resp) {
            equal(resp, "hi\nyo\n", "showed up");
        }).
        always(function() {
            equal(this.state(), "resolved", "didn't fail");
            start();
        });
});

asyncTest("write close read", function() {
    expect(2);

    var proc = cockpit.spawn(["/usr/bin/sort"]);

    proc.done(function(resp) {
        equal(resp, "1\n2\n3\n", "output");
    });

    proc.always(function() {
        equal(this.state(), "resolved", "didn't fail");
        start();
    });

    proc.write("2\n");
    proc.write("3\n1\n");
    proc.close();
});


QUnit.start();

</script>
</html>

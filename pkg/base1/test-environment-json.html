<!DOCTYPE html>
<!--
  This file is part of Cockpit.

  Copyright (C) 2015 Red Hat, Inc.

  Cockpit is free software; you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation; either version 2.1 of the License, or
  (at your option) any later version.

  Cockpit is distributed in the hope that it will be useful, but
  WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with Cockpit; If not, see <http://www.gnu.org/licenses/>.
-->
<html>
  <head>
    <title>Environment Json Channel Tests</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../tools/qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="../../tools/qunit.js"></script>

    <script type="text/javascript" src="cockpit.js"></script>
  </head>
  <body>
    <h1 id="qunit-header">>Environment Json Channel Tests</h1>
    <h2 id="qunit-banner"></h2><div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2><ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <div id="done-flag" style="display:none">Done</div>
  </body>
<script type="text/javascript">

asyncTest("bad", function() {
    expect(1);

    var problem = "protocol-error"
    var channel = cockpit.channel({ "payload": "environment-json",
                                    "vars" : "invalid" });

    $(channel).on("close", function (ev, ex) {
        strictEqual(ex.problem, "protocol-error", "invalid options");
        start();
    });
});

asyncTest("basic", function() {
    expect(2);

    var channel = cockpit.channel({ "payload": "environment-json",
                                    "vars" : ["NO_VAR", "GIO_USE_VFS" ] });

    $(channel).on("close", function (ev, ex) {
        strictEqual(ex.problem, undefined, "closed with no problem");
        start();
    });

    $(channel).on("message", function(ev, response) {
        var json = JSON.parse(response);
        propEqual(json, {
            "GIO_USE_VFS" : "local",
            "NO_VAR" : null,
        }, "got valid response");
    });
});

asyncTest("empty", function() {
    expect(2);

    var channel = cockpit.channel({ "payload": "environment-json",
                                    "vars" : [ ] });

    $(channel).on("close", function (ev, ex) {
        strictEqual(ex.problem, undefined, "closed with no problem");
        start();
    });

    $(channel).on("message", function(ev, response) {
        var json = JSON.parse(response);
        propEqual(json, {}, "got empty response");
    });
});

QUnit.start();

</script>
</html>

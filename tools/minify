#! /bin/bash
# This file is part of Cockpit.
#
# Copyright (C) 2013 Red Hat, Inc.
#
# Cockpit is free software; you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation; either version 2.1 of the License, or
# (at your option) any later version.
#
# Cockpit is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with Cockpit; If not, see <http://www.gnu.org/licenses/>.

set -euf

usage()
{
	echo "usage: minify [-o output] file ..." >&2
	exit 2
}

success=no
output=

cleanup()
{
	if [ "$output" ]; then
		if [ "$success" == "yes" ]; then
			mv "$output.tmp" "$output"
		else
			rm "$output.tmp"
		fi
	fi
}

trap cleanup EXIT 

while getopts "o:" opt; do
	case "$opt" in
	o)
		output="$OPTARG"
		exec > "$output.tmp"
		;;
	*)
		usage
		;;
	esac
done

shift $(expr $OPTIND - 1)

perl -e \
'use strict;
use JavaScript::Minifier::XS qw(minify);

for my $f (@ARGV) {
    local ($/);
    open my $in, "<", $f or die "$f: $!\n";
    print minify(<$in>);
    close $in;
}' $@ \
|| (
	echo >&2 "minify: no worries, using cat instead"
	echo "/* This file is automatically generated; DO NOT EDIT */"
	cat "$@"
   )

success=yes

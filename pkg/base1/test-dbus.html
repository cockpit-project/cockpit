<!DOCTYPE html>
<!--
This file is part of Cockpit.

Copyright (C) 2014 Red Hat, Inc.

Cockpit is free software; you can redistribute it and/or modify it
under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation; either version 2.1 of the License, or
(at your option) any later version.

Cockpit is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with Cockpit; If not, see <http://www.gnu.org/licenses/>.
-->
<html>
<head>
    <meta charset="utf-8">
    <title>D-Bus Tests</title>
    <link rel="stylesheet" href="../../tools/qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="../../tools/qunit.js"></script>
    <script type="text/javascript" src="test-dbus-common.js"></script>
    <script type="text/javascript" src="cockpit.js"></script>
</head>
<body>
    <h1 id="qunit-header">D-Bus Tests</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <div id="done-flag" style="display:none">Done</div>
<script id='dbus-tests'>

/* with a name */
var options = {
    "bus": "session"
};
common_dbus_tests(options, "com.redhat.Cockpit.DBusTests.Test");
dbus_track_tests(options, "com.redhat.Cockpit.DBusTests.Test");

test("proxy no stutter", function() {
    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test", { "bus": "session" });

    var proxy = dbus.proxy();
    equal(proxy.iface, "com.redhat.Cockpit.DBusTests.Test", "interface auto chosen");
    equal(proxy.path, "/com/redhat/Cockpit/DBusTests/Test", "path auto chosen");
});

test("proxies no stutter", function() {
    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test", { "bus": "session" });

    var proxies = dbus.proxies();
    equal(proxies.iface, "com.redhat.Cockpit.DBusTests.Test", "interface auto chosen");
    equal(proxies.path_namespace, "/", "path auto chosen");
});

test("exposed client and options", function() {
    var options = { host: "localhost", "bus": "session" };
    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test", options);
    var proxy = dbus.proxy("com.redhat.Cockpit.DBusTests.Frobber", "/otree/frobber");
    var proxies = dbus.proxies("com.redhat.Cockpit.DBusTests.Frobber");

    deepEqual(dbus.options, options, "client object exposes options");
    strictEqual(proxy.client, dbus, "proxy object exposes client");
    strictEqual(proxies.client, dbus, "proxies object exposes client");
});

test("subscriptions on closed client", function() {
    function on_signal() {
    }

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test", { "bus": "session" });
    dbus.close();

    var subscription = dbus.subscribe({
        "interface": "com.redhat.Cockpit.DBusTests.Frobber",
        "path": "/otree/frobber"
    }, on_signal);
    ok(subscription, "can subscribe");

    subscription.remove();
    ok(true, "can unsubscribe");
});

test("watch promise recursive", function() {
    expect(7);

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test", { "bus": "session" });
    var promise = dbus.watch("/otree/frobber");

    var target = { };
    var promise2 = promise.promise(target);
    strictEqual(promise2, target, "used target");
    equal(typeof promise2.done, "function", "promise2.done()");
    equal(typeof promise2.promise, "function", "promise2.promise()");
    equal(typeof promise2.remove, "function", "promise2.remove()");

    var promise3 = promise2.promise();
    equal(typeof promise3.done, "function", "promise3.done()");
    equal(typeof promise3.promise, "function", "promise3.promise()");
    equal(typeof promise3.remove, "function", "promise3.remove()");
});

asyncTest("owned messages", function() {
    expect(9);

    var name = "yo.x" + new Date().getTime();
    var times_changed = 0;

    var dbus = cockpit.dbus("com.redhat.Cockpit.DBusTests.Test", { "bus": "session" });
    var other = null;
    var org_owner = null;
    function on_owner (event, owner) {
        if (times_changed === 0) {
            strictEqual(typeof owner, "string", "intial owner string");
            ok(owner.length > 1, "intial owner not empty");
            org_owner = owner;
        } else if (times_changed === 1) {
            strictEqual(owner, null, "no owner");
        } else if (times_changed === 2) {
            // owner is the same because the server
            // dbus connection is too.
            strictEqual(owner, org_owner, "has owner again");
        }
        times_changed++;
    }

    function acquire_name () {
        dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
                  "ClaimOtherName", [ name ])
            .always(function() {
                equal(this.state(), "resolved", "name claimed");
                if (!other) {
                    other = cockpit.dbus(name, { "bus": "session" });
                    $(other).on("owner", on_owner);
                    release_name();
                } else {
                    strictEqual(times_changed, 3, "owner changed three times");
                    start();
                }
            });
    }

    function release_name () {
        other.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
                        "HelloWorld", [ "test" ])
                  .always(function() {
                        equal(this.state(), "resolved", "called on other name");

                        dbus.call("/otree/frobber", "com.redhat.Cockpit.DBusTests.Frobber",
                                  "ReleaseOtherName", [ name ])
                            .always(function() {
                                equal(this.state(), "resolved", "name released");
                                acquire_name();
                            });
                  });
    }
    acquire_name();
});

asyncTest("bad dbus address", function() {
    expect(1);

    var dbus = cockpit.dbus(null, { "bus": "none", "address": "bad" });
    $(dbus).on("close", function(event, options) {
        equal(options.problem, "protocol-error", "bad address closed");
        start();
    });
});

asyncTest("bad dbus bus", function() {
    expect(1);

    var dbus = cockpit.dbus(null, { "bus": "bad" });
    $(dbus).on("close", function(event, options) {
        equal(options.problem, "protocol-error", "bad bus format");
        start();
    });
});

function internal_test(options) {
    expect(2);
    var dbus = cockpit.dbus(null, options);
    dbus.call("/", "org.freedesktop.DBus.Introspectable", "Introspect")
        .done(function(resp) {
            ok(String(resp[0]).indexOf("<node") !== -1, "introspected internal");
        })
        .always(function() {
            equal(this.state(), "resolved", "called internal");
            start();
        });
}

asyncTest("internal dbus", function() {
    internal_test({"bus": "internal"});
});

asyncTest("internal dbus bus none", function() {
    internal_test({"bus": "none"});
});

asyncTest("internal dbus bus none with address", function() {
    internal_test({"bus": "none", "address": "internal"});
});

QUnit.start();
</script>
</body>
</html>
